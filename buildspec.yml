version: 0.2

phases:
  pre_build:
    commands:
      - echo "=========================================="
      - echo "Stage 1: PRE-BUILD"
      - echo "=========================================="
      - echo "üî® Iniciando build..."
      - echo "üìÖ Timestamp: $(date)"
      - echo ""
      - echo "üîë Fazendo login no ECR..."
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/seu-app
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - IMAGE_TAG=${COMMIT_HASH:=latest}
      - echo "‚úÖ Login bem-sucedido"
      - echo ""

  build:
    commands:
      - echo "=========================================="
      - echo "Stage 2: BUILD"
      - echo "=========================================="
      - echo ""
      - echo "üß™ Executando testes..."
      - pip install -r requirements.txt
      - pytest tests/ -v --cov=. --cov-report=xml
      - echo "‚úÖ Testes passaram!"
      - echo ""
      - echo "üê≥ Buildando imagem Docker..."
      - docker build -t $REPOSITORY_URI:latest .
      - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG
      - echo "‚úÖ Build completo"
      - echo ""

  post_build:
    commands:
      - echo "=========================================="
      - echo "Stage 3: POST-BUILD"
      - echo "=========================================="
      - echo ""
      - echo "üì§ Fazendo push para ECR..."
      - docker push $REPOSITORY_URI:latest
      - docker push $REPOSITORY_URI:$IMAGE_TAG
      - echo "‚úÖ Push para ECR completo"
      - echo ""
      - echo "üìù Gerando imagedefinitions.json..."
      - printf '[{"name":"seu-app","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
      - cat imagedefinitions.json
      - echo ""
      - echo "=========================================="
      - echo "‚úÖ BUILD CONCLU√çDO COM SUCESSO!"
      - echo "=========================================="

artifacts:
  files:
    - imagedefinitions.json
  name: BuildArtifact

cache:
  paths:
    - "/root/.cache/pip/**/*"

reports:
  coverage:
    files:
      - coverage.xml
    file-format: "COBERTURAXML"
